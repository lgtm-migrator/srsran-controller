from pyshark import FileCapture

from srslte_controller.uu_events.nas_emm_detach_request import create as create_detach_request

DETACH_REQUEST_PCAP_DATA = (
    'd4c3b2a1020004000000000000000000ffff000093000000f88f79604d170800280200002802000001000302004703000004'
    '322807010a000f00013a3e211f1f35000000a0000020002a2e41c91006040e8a1217ec01e22000023472c1edb00000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
)


def test_parsing_emm_detach_request(tmp_path):
    p = tmp_path / 'detach_request.pcap'
    p.write_bytes(bytes.fromhex(DETACH_REQUEST_PCAP_DATA))
    pcap = FileCapture(str(p))
    rar = create_detach_request(list(pcap)[0])
    assert rar == {'tmsi': '0x3960f6d8', 'event': 'Detach request', 'rnti': 71}
